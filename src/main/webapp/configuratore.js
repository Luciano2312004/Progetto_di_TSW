const autoColorsDatabase = {
  'la ferrari': { buttons: [{ name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'blue', code: 'blu', image: './images/button-deep-blue-metallic.png' }, { name: 'grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'sf': { buttons: [{ name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'ultra-red', code: 'rosso-scuro', image: './images/button-ultra-red.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  '812': { buttons: [{ name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'enzo': { buttons: [{ name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'Ultra-Red', code: 'rosso-scuro', image: './images/button-ultra-red.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }, { name: 'yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }] },
  'f8': { buttons: [{ name: 'blue', code: 'blu', image: './images/button-deep-blue-metallic.png' }, { name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'Orange', code: 'arancione', image: './images/button-orange.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'aventador': { buttons: [{ name: 'blue', code: 'blu', image: './images/button-light-blue.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'Ultra Red', code: 'rosso-scuro', image: './images/button-ultra-red.png' }, { name: 'yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'sian': { buttons: [{ name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'revuelto': { buttons: [{ name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'Purple', code: 'viola', image: './images/button-purple.png' }, { name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'veneno': { buttons: [{ name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  '911': { buttons: [{ name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Green', code: 'verde', image: './images/button-watergreen.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }, { name: 'yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }] },
  '918': { buttons: [{ name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }, { name: 'yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }] },
  '918 spider': { buttons: [{ name: 'Red', code: 'rosso', image: './images/button-red.png' }] },
  '720': { buttons: [{ name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'Orange', code: 'arancione', image: './images/button-orange.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'p1': { buttons: [{ name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'Orange', code: 'arancione', image: './images/button-orange.png' }, { name: 'yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'chiron': { buttons: [{ name: 'blue', code: 'blu', image: './images/button-deep-blue-metallic.png' }, { name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'divo': { buttons: [{ name: 'Deep Blue', code: 'blu', image: './images/button-deep-blue-metallic.png' }, { name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }] },
  'jesko': { buttons: [{ name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }, { name: 'yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }] },
  'agera': { buttons: [{ name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }, { name: 'Orange', code: 'arancione', image: './images/button-orange.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'regera': { buttons: [{ name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'Pearl White', code: 'bianco', image: './images/button-pearl-white.png' }, { name: 'yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }, { name: 'Stealth Grey', code: 'grigio', image: './images/button-quicksilver.png' }] }
};
const autoInteriorColorsDatabase = {
  'divo': { buttons: [{ name: 'Blue', code: 'blu', image: './images/button-deep-blue-metallic.png' }, { name: 'Black', code: 'nero', image: './images/button-solid-black.png' }] },
  '720': { buttons: [{ name: 'Yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }, { name: 'Orange', code: 'arancione', image: './images/button-orange.png' }] },
  'p1': { buttons: [{ name: 'Yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }, { name: 'Orange', code: 'arancione', image: './images/button-orange.png' }] },
  'chiron': { buttons: [{ name: 'Blue', code: 'blu', image: './images/button-deep-blue-metallic.png' }, { name: 'Purple', code: 'viola', image: './images/button-purple.png' }] },
  '812': { buttons: [{ name: 'Yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }] },
  'enzo': { buttons: [{ name: 'Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }] },
  'f8': { buttons: [{ name: 'Solid Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' },] },
  'la ferrari': { buttons: [{ name: 'Black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }] },
  'sf': { buttons: [{ name: 'Red', code: 'rosso', image: './images/button-red.png' }, { name: 'black', code: 'nero', image: './images/button-solid-black.png' }] },
  'agera': { buttons: [{ name: 'Yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }, { name: 'White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'jesko': { buttons: [{ name: 'Yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }, { name: 'White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'regera': { buttons: [{ name: 'Yellow', code: 'giallo', image: './images/button-thunder-yellow.png' }, { name: 'White', code: 'bianco', image: './images/button-pearl-white.png' }] },
  'revuelto': { buttons: [{ name: 'Orange', code: 'arancione', image: './images/button-orange.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }] },
  'sian': { buttons: [{ name: 'White', code: 'bianco', image: './images/button-pearl-white.png' }, { name: 'Orange', code: 'arancione', image: './images/button-orange.png' }] },
  'veneno': { buttons: [{ name: 'Orange', code: 'arancione', image: './images/button-orange.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }] },
  '911': { buttons: [{ name: 'black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }] },
  '918': { buttons: [{ name: 'black', code: 'nero', image: './images/button-solid-black.png' }, { name: 'Red', code: 'rosso', image: './images/button-red.png' }] },
  'aventador': { buttons: [{ name: 'White', code: 'bianco', image: './images/button-pearl-white.png' }, { name: 'Orange', code: 'arancione', image: './images/button-orange.png' }] }
};

/* === VARIABILI GLOBALI === */
window.autoCorrente = null; 
window.basePrice = 52490; 

let currentPrice = 52490;
let interiorSet = 1;
let selectedWheelType = 'Standard';
let selectedColor = 'Stealth Grey';
let selectedInteriorColor = 'Dark';
let currentGalleryIndex = 0;
let isAnimating = false;
let currentStats = { power: 900, speed: 350, acceleration: 2.9 }; 
let selectedPackages = new Set();
let selectedAdvancedOptions = new Set();

const optionsPrices = {
    wheel: 0,
    packages: 0,
    autopilot: 0,
    accessories: 0,
};

const pricing = {
  'Performance': 2500, 
  Packages: {
    'performance': 5000,
    'comfort': 3000,
    'sport': 4500,
    'tech': 3500,
  },
  AdvancedOptions: {
  'Autopilot-base': 2500,
  'Autopilot-advanced': 1800,
  'Autopark': 3200,
  'Smart-summon': 2800,
  },
};

/* === FUNZIONI DINAMICHE === */

const loadColorButtons = (autoData) => {
  const colorSection = document.getElementById('exterior-buttons');
  if(!colorSection) return;
  const buttonContainer = colorSection.querySelector('.flex');
  const modelKey = autoData.modello.toLowerCase();
  const availableColors = autoColorsDatabase[modelKey];
  
  if (!availableColors) {
	buttonContainer.innerHTML = '<p class="text-sm text-gray-500">Colori non disponibili.</p>';
	return;
  }
  
  buttonContainer.innerHTML = '';
  availableColors.buttons.forEach((colorBtn) => {
    const button = document.createElement('button');
    button.className = 'transition-transform duration-300 hover:scale-110';
    if (colorBtn.code === autoData.colore.toLowerCase()) {
      button.classList.add('btn-selected');
      selectedColor = colorBtn.name;
    }
    const img = document.createElement('img');
    img.src = colorBtn.image;
    img.alt = colorBtn.name;
	img.dataset.code = colorBtn.code;
    img.className = 'w-20';
    button.appendChild(img);
    buttonContainer.appendChild(button);
  });
};

const loadInteriorColorButtons = (autoData) => {
  const section = document.getElementById('interior-buttons');
  if(!section) return;
  const container = section.querySelector('.flex');
  const modelKey = autoData.modello.toLowerCase();
  const available = autoInteriorColorsDatabase[modelKey];

  if (!available) {
	container.innerHTML = '<p class="text-sm text-gray-500">Interni non disponibili.</p>';
	return;
  }
  container.innerHTML = '';
  let defaultColorIndex = 0;
  if (modelKey === 'f8') {
    const blackIndex = available.buttons.findIndex(btn => btn.name.toLowerCase().includes('black') || btn.code === 'nero');
    if (blackIndex !== -1) defaultColorIndex = blackIndex;
  } else {
    const redIndex = available.buttons.findIndex(btn => btn.name.toLowerCase().includes('red') || btn.code === 'rosso');
    if (redIndex !== -1) defaultColorIndex = redIndex;
  }

  available.buttons.forEach((btn, index) => {
    const button = document.createElement('button');
    button.className = 'transition-transform duration-300 hover:scale-110';
    button.dataset.interiorCode = btn.code;
    const img = document.createElement('img');
    img.src = btn.image;
    img.alt = btn.name;
    img.className = 'w-12';
    if (index === defaultColorIndex) {
      button.classList.add('btn-selected');
      selectedInteriorColor = btn.name;
    }
    button.appendChild(img);
    container.appendChild(button);
  });
};

// *** 'contextPath' PER CREARE PERCORSI ASSOLUTI ***
const getImagePath = (marca, modello, view, colore = null, interiorColor = null) => {
  
  const baseCtx = typeof contextPath !== 'undefined' ? contextPath : '';

  const brandNormalized = marca.toLowerCase().replace(/\s+/g, '');
  const modelNormalized = modello.toLowerCase().replace(/[\s-]+/g, '').replace(/[àáâãäå]/g, 'a').replace(/[èéêë]/g, 'e').replace(/[ìíîï]/g, 'i').replace(/[òóôõö]/g, 'o').replace(/[ùúûü]/g, 'u');
  const viewMap = { front: 'f', side: 's', rear: 'r', interior1: 'intern1', interior2: 'intern2' };
  const colorMap = { 'rosso': 'r', 'red': 'r', 'rosso-scuro': 'ur', 'ultra-red': 'ur', 'giallo': 'y', 'yellow': 'y', 'grigio': 'g', 'grey': 'g', 'gray': 'g', 'nero': 'bl', 'black': 'bl', 'bianco': 'w', 'white': 'w', 'blu': 'b', 'blue': 'b', 'azzurro': 'b', 'cyan': 'b', 'verde': 'v', 'green': 'v', 'arancione': 'o', 'orange': 'o', 'viola': 'p', 'purple': 'p' };

  let viewSuffix = viewMap[view] || 'f';

  // GESTIONE INTERNI
  if (view.includes('interior')) {
  	let colorSuffix = '';
	if (interiorColor) {
		const key = String(interiorColor).toLowerCase();
    	colorSuffix = colorMap[key] || key.charAt(0);
		viewSuffix = viewSuffix.replace(/(\d+)$/, colorSuffix + '$1');
	}
  	if (interiorSet === 2) viewSuffix = viewSuffix.replace(/(\d+)$/, '$1$1');
  	return `${baseCtx}/images/${brandNormalized}/${modelNormalized}${viewSuffix}.png`; // Usa baseCtx
  }

  // GESTIONE ESTERNI
  let colorSuffix = '';
  if (colore) {
    const key = String(colore).toLowerCase();
    colorSuffix = colorMap[key] || key.charAt(0);
  }

  let basePath = `${baseCtx}/images/${brandNormalized}/${modelNormalized}${viewSuffix}${colorSuffix}`; // Usa baseCtx
  if (selectedWheelType === 'Performance') {
    basePath += '-performance';
  }
  return `${basePath}.png`;
};

// Aggiorna la galleria per l'auto specifica
const updateGalleryForCar = (autoData) => {
    const gallery = document.getElementById('exterior-gallery');
	const exteriorImage = document.getElementById('exterior-image');
	if (!gallery || !exteriorImage) return;

    gallery.innerHTML = ''; // Cancella la galleria statica
    const views = ['front', 'side', 'rear', 'interior1', 'interior2'];
    const angleLabels = ['Vista Frontale', 'Vista Laterale', 'Vista Retro', 'Interni 1', 'Interni 2'];
	
	const currentExtColorCode = autoData.colore.toLowerCase();
	const intDb = autoInteriorColorsDatabase[autoData.modello.toLowerCase()];
	let currentIntColorCode = 'nero';
	if(intDb) {
		currentIntColorCode = intDb.buttons[0].code;
	}
    
    views.forEach((view, index) => {
        const img = document.createElement('img');
        let imagePath = getImagePath(autoData.marca, autoData.modello, view, currentExtColorCode, currentIntColorCode);
        img.src = imagePath; 
        img.alt = angleLabels[index];
        img.className = 'thumbnail w-24 h-24 object-cover cursor-pointer border-2 border-transparent hover:border-gray-400';
        img.dataset.src = imagePath;
		img.dataset.view = view; 

       
        if (view === 'front') {
            img.id = 'frontimg';
        }

        img.onerror = () => { img.src = `${contextPath}/images/placeholder.jpg`; }; 
        img.addEventListener('click', () => showGalleryImage(index));
        gallery.appendChild(img);
    });
    
    if (gallery.children.length > 0) {
        gallery.children[0].classList.add('border-blue-500', 'border-2');
		gallery.children[0].classList.remove('border-transparent');
    }
    
    const firstImagePath = getImagePath(autoData.marca, autoData.modello, 'front', currentExtColorCode);
    exteriorImage.src = firstImagePath;
	

	
    currentGalleryIndex = 0;
};

// Carica i dati dell'auto all'avvio
const loadCarData = () => {
    const autoData = sessionStorage.getItem('autoSelezionata');
	const titleElement = document.querySelector('aside h1');
    
    if (autoData) {
        window.autoCorrente = JSON.parse(autoData);
        if (titleElement) titleElement.textContent = window.autoCorrente.modello;
        window.basePrice = parseInt(window.autoCorrente.prezzoBase, 10) || 52490;
    } else {
		window.autoCorrente = { 
			marca: "Ferrari", 
			modello: "La Ferrari", 
			colore: "Rosso", 
			prezzoBase: "2300000",
			potenza: "900 CV"
		};
		if (titleElement) titleElement.textContent = "LaFerrari";
		window.basePrice = 2300000;
    }
	
	updateStatsForCar(window.autoCorrente);
    loadColorButtons(window.autoCorrente);
	loadInteriorColorButtons(window.autoCorrente);
    updateGalleryForCar(window.autoCorrente);
	updatePrice();
	animateCounters();
};

const updateStatsForCar = (autoData) => {
    const potenza = parseInt(autoData.potenza.replace(/[^\d]/g, '')) || 622;
    const velocita = Math.round(potenza * 0.32 + 100);
    const accelerazione = Math.max(2.1, 8.5 - (potenza / 150)).toFixed(1);
    currentStats = { power: potenza, speed: velocita, acceleration: parseFloat(accelerazione) };
};

/* ===  (Calcolo Prezzi, Galleria, Contatori) === */

function animateCounter(element, target, duration = 1000, suffix = '') {
  let startValue = parseFloat(element.textContent.replace(/[^\d.-]/g, '')) || 0;
  const startTime = performance.now();
  
  element.classList.add('counter-animating');
  
  const updateCounter = (currentTime) => {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easeOut = 1 - Math.pow(1 - progress, 3);
    const currentValue = startValue + (target - startValue) * easeOut;
    
    if (suffix === 's') {
      element.textContent = currentValue.toFixed(1);
    } else {
      element.textContent = Math.floor(currentValue);
    }
    
    if (progress < 1) {
      requestAnimationFrame(updateCounter);
    } else {
      element.classList.remove('counter-animating');
      if (suffix === 's') {
        element.textContent = target.toFixed(1);
      } else {
        element.textContent = target;
      }
    }
  };
  requestAnimationFrame(updateCounter);
}

function animateCounters() {
    animateCounter(document.getElementById('range-counter'), currentStats.power, 1500);
    animateCounter(document.getElementById('speed-counter'), currentStats.speed, 1500);
    animateCounter(document.getElementById('acceleration-counter'), currentStats.acceleration, 1500, 's');
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
}

function updateAccessoryPrice() {
    let price = 0;
    document.querySelectorAll('#accessories-section .accessory-form-checkbox:checked').forEach(checkbox => {
        price += parseFloat(checkbox.dataset.price) || 0;
    });
    optionsPrices.accessories = price;
    updatePrice(); // Aggiorna il totale
}

function updatePrice() {
    currentPrice = window.basePrice;
    
    currentPrice += optionsPrices.wheel;
    currentPrice += optionsPrices.packages;
    currentPrice += optionsPrices.autopilot;
    currentPrice += optionsPrices.accessories;
    
    const totalPriceEl = document.getElementById('total-price');
    if (totalPriceEl) {
        totalPriceEl.textContent = formatCurrency(currentPrice);
    }
    
    const downPaymentEl = document.getElementById('down-payment');
    const monthlyPaymentEl = document.getElementById('monthly-payment');
    if(downPaymentEl && monthlyPaymentEl) {
        const downPayment = currentPrice * 0.10;
        const loanAmount = currentPrice - downPayment;
        const monthlyRate = 0.03 / 12;
        const totalPayments = 60;
        const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalPayments)) / (Math.pow(1 + monthlyRate, totalPayments) - 1);
        
        downPaymentEl.textContent = formatCurrency(downPayment);
        monthlyPaymentEl.textContent = formatCurrency(monthlyPayment);
    }
}

function updateGallery(view, colorCode, intColorCode) {
    if (!window.autoCorrente) return;
    
    const exteriorImage = document.getElementById('exterior-image');
    const galleryThumbnails = document.querySelectorAll('#exterior-gallery .thumbnail');
    
    const mainImagePath = getImagePath(window.autoCorrente.marca, window.autoCorrente.modello, view, colorCode, intColorCode);
    exteriorImage.src = mainImagePath;

    galleryThumbnails.forEach((thumb, index) => {
        const thumbView = thumb.dataset.view;
        const newSrc = getImagePath(window.autoCorrente.marca, window.autoCorrente.modello, thumbView, colorCode, intColorCode);
        thumb.src = newSrc;
        thumb.dataset.src = newSrc;
        
        if (index === currentGalleryIndex) {
            thumb.classList.add('border-blue-500', 'border-2');
            thumb.classList.remove('border-transparent');
        } else {
            thumb.classList.remove('border-blue-500', 'border-2');
            thumb.classList.add('border-transparent');
        }
    });
    
    // *** Aggiorna l'SRC della thumbnail 'frontimg' così il carrello la trova ***
    const frontThumb = document.getElementById('frontimg');
    if (frontThumb) {
    	frontThumb.src = getImagePath(window.autoCorrente.marca, window.autoCorrente.modello, 'front', colorCode, intColorCode);
    }
}

function showGalleryImage(index) {
    const galleryThumbnails = document.querySelectorAll('#exterior-gallery .thumbnail');
    if (isAnimating || index === currentGalleryIndex || !galleryThumbnails[index]) return;

    isAnimating = true;
    currentGalleryIndex = index;
    const newSrc = galleryThumbnails[index].dataset.src;
    
    galleryThumbnails.forEach((thumb, i) => {
        thumb.classList.toggle('border-blue-500', i === index);
		thumb.classList.toggle('border-2', i === index);
        thumb.classList.toggle('border-transparent', i !== index);
    });

    const exteriorImage = document.getElementById('exterior-image');
    exteriorImage.style.opacity = '0';
	exteriorImage.style.transition = 'opacity 0.3s ease-out';
    setTimeout(() => {
        exteriorImage.src = newSrc;
        exteriorImage.style.opacity = '1';
        isAnimating = false;
    }, 300);
}


/* === BLOCCO DI INIZIALIZZAZIONE === */
document.addEventListener("DOMContentLoaded", () => {
    
    loadCarData(); // Carica i dati dell'auto da sessionStorage

    const optionsContainers = {
        colors: document.getElementById('exterior-buttons'),
        intColors: document.getElementById('interior-buttons'),
        wheel: document.getElementById('wheel-buttons'),
        packages: document.getElementById('packages-section'),
        autopilot: document.getElementById('advanced-options-section'),
        accessories: document.getElementById('accessories-section')
    };

   
// Handler per bottoni a selezione singola (colori, ruote)
const handleButtonSelection = (container, selector, priceType) => {
    if (!container) return;
    container.addEventListener('click', (e) => {
        const selectedButton = e.target.closest(selector);
        
       
        if (!selectedButton || selectedButton.classList.contains('btn-selected') || selectedButton.classList.contains('disabled')) {
            return;
        }

        // 1. Deseleziono tutti gli altri
        container.querySelectorAll(selector).forEach(btn => {
            btn.classList.remove('btn-selected');
            btn.setAttribute('aria-pressed', 'false'); 
        });

        // 2. Seleziono questo 
        selectedButton.classList.add('btn-selected');
        selectedButton.setAttribute('aria-pressed', 'true'); 
        
        // 3. Calcolo il prezzo
        let price = parseFloat(selectedButton.dataset.price) || 0;

        if (priceType === 'wheel') {
             const wheelName = selectedButton.dataset.wheel; // es. "Performance"
             selectedWheelType = wheelName;
             
             
             if (price === 0 && pricing[wheelName]) {
                 price = pricing[wheelName];
             }
             optionsPrices.wheel = price;
        } 
        
        if (priceType === 'color') {
             selectedColor = selectedButton.querySelector('img').alt;
        }
        if (priceType === 'intColor') {
             selectedInteriorColor = selectedButton.querySelector('img').alt;
        }

        updatePrice();
        
        // Aggiorna la galleria se cambiano ruote o colori
        if (priceType === 'wheel' || priceType === 'color' || priceType === 'intColor') {
             const currentView = document.querySelectorAll('#exterior-gallery .thumbnail')[currentGalleryIndex]?.dataset.view || 'front';
             const extColorCode = document.querySelector("#exterior-buttons .btn-selected img")?.dataset.code || window.autoCorrente.colore.toLowerCase();
             const intColorCode = document.querySelector("#interior-buttons .btn-selected")?.dataset.interiorCode || selectedInteriorColor.toLowerCase();
             
             updateGallery(currentView, extColorCode, intColorCode);
        }
    });
};


//Handler per pacchetti (selezione multipla)
const handlePackageSelection = (container, selector, priceType) => {
    if (!container) return;
    container.addEventListener('click', (e) => {
        const target = e.target.closest(selector);
		if(!target || target.classList.contains('disabled')) return;
		
      	 target.classList.toggle('selected'); // Per l'evidenziazione
        
      	 let price = 0;
      	 let packageBoost = { power: 0, speed: 0, acceleration: 0 };
      	 selectedPackages.clear(); 

      	 container.querySelectorAll(`${selector}.selected`).forEach(item => {
      	     price += parseFloat(item.dataset.price) || 0;
    	 	 	 const packageName = item.dataset.package;
    	 	 	 selectedPackages.add(packageName);

    	 	 	 // Definiamo i boost delle statistiche
    	 	 	 if (packageName === 'performance') {
    	 	 	 	 packageBoost.power += 50;
    	 	 	 	 packageBoost.speed += 10;
    	 	 	 	 packageBoost.acceleration -= 0.1;
    	 	 	 } else if (packageName === 'sport') {
    	 	 	 	 packageBoost.power += 20;
    	 	 	 	 packageBoost.speed += 5;
    	 	 	 }
    	 	 	 });
        
      	 optionsPrices[priceType] = price;
      	 // Non chiamiamo updatePrice() subito, lo facciamo dopo

      	 // 1. Prendi le statistiche di base dell'auto
      	 const basePotenza = parseInt(window.autoCorrente.potenza.replace(/[^\d]/g, '')) || 622;
      	 const baseVelocita = Math.round(basePotenza * 0.32 + 100);
  	 	 	 const baseAccelerazione = Math.max(2.1, 8.5 - (basePotenza / 150));

      	 // 2. Applica i boost alle statistiche correnti
      	 currentStats.power = basePotenza + packageBoost.power;
      	 currentStats.speed = baseVelocita + packageBoost.speed;
  	 	 	 currentStats.acceleration = parseFloat(baseAccelerazione.toFixed(1)) + packageBoost.acceleration;
    
      	 // 3. Avvia l'animazione dei contatori
      	 animateCounters();

      	 // 4. Scrolla se il pacchetto cliccato è 'performance' o 'sport'
      	 
      	 const clickedPackageName = target.dataset.package;
      	 const affectsStats = (clickedPackageName === 'performance' || clickedPackageName === 'sport');
      	 const isSelected = target.classList.contains('selected');

      	 if (affectsStats && isSelected) {
      	 	 const statsEl = document.getElementById('range-counter');
      	 	 if (statsEl) {
      	 	 	 statsEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      	 	 }
      	 }
      	 
      	 // 5. Logica per APPLE CAR PLAY
      	 if (clickedPackageName === 'tech') {
      	 	 const carPlayCheckbox = document.querySelector('.accessory-form-checkbox[data-price="350"]');
      	 	 if (carPlayCheckbox) {
      	 	 	 carPlayCheckbox.checked = isSelected;
      	 	 	 updateAccessoryPrice(); // Ricalcola prezzo accessori e aggiorna totale
      	 	 } else {
      	 	 	 updatePrice(); // Aggiorna solo il prezzo dei pacchetti
      	 	 }
      	 } else {
      	 	 updatePrice(); // Aggiorna il prezzo per gli altri pacchetti
      	 }
    });
};
	
	// Handler dedicato per l'Autopilota
	const handleAutopilotSelection = (container, selector) => {
	    if (!container) return;
	    
	    const autopark = container.querySelector('[data-option="Autopark"]');
	    const summon = container.querySelector('[data-option="Smart-summon"]');

	    container.addEventListener('click', (e) => {
	    	const selectedButton = e.target.closest(selector);
	    	if (!selectedButton || selectedButton.classList.contains('disabled')) return;

	    	const optionName = selectedButton.dataset.option;
	  	 	 	const isBaseOption = optionName === 'Autopilot-base' || optionName === 'Autopilot-advanced';
	  	 	 	const isChildOption = optionName === 'Autopark' || optionName === 'Smart-summon';

	  	 	 	if (isBaseOption) {
	  	 	 		if (selectedButton.classList.contains('btn-selected')) {
	  	 	 			// Deseleziono l'opzione base
	  	 	 			selectedButton.classList.remove('btn-selected');
	    				selectedAdvancedOptions.delete(optionName);
	    				
	    				// Blocco e deseleziono le opzioni figlie
	    				autopark.classList.add('disabled');
	    				autopark.classList.remove('btn-selected');
	    				selectedAdvancedOptions.delete('Autopark');
	    				
	    				summon.classList.add('disabled');
	    				summon.classList.remove('btn-selected');
	    				selectedAdvancedOptions.delete('Smart-summon');

	  	 	 		} else {
	  	 	 			// Seleziono una nuova opzione base
	  	 	 			// 1. Deseleziono le altre opzioni base
	  	 	 			container.querySelectorAll(selector).forEach(btn => {
	    					if(btn.dataset.option === 'Autopilot-base' || btn.dataset.option === 'Autopilot-advanced') {
	    						btn.classList.remove('btn-selected');
	    						selectedAdvancedOptions.delete(btn.dataset.option);
	    					}
	    				});
	    				// 2. Seleziono questa
	    				selectedButton.classList.add('btn-selected');
	    				selectedAdvancedOptions.add(optionName);

	    				// 3. Sblocco le opzioni figlie
	    				autopark.classList.remove('disabled');
	    				summon.classList.remove('disabled');

	    				// 4. Scroll per mostrare le nuove opzioni
	    				summon.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
	  	 	 		}
	  	 	 	} else if (isChildOption) {
	  	 	 		
	  	 	 		selectedButton.classList.toggle('btn-selected');
	  	 	 		if (selectedButton.classList.contains('btn-selected')) {
	    				selectedAdvancedOptions.add(optionName);
	    			} else {
	    				selectedAdvancedOptions.delete(optionName);
	    			}
	  	 	 	}

	  	 	 	// Ricalcolo il prezzo totale dell'autopilota
	  	 	 	let autopilotPrice = 0;
	  	 	 	selectedAdvancedOptions.forEach(optName => {
	  	 	 		const optEl = container.querySelector(`[data-option="${optName}"]`);
	  	 	 		if (optEl) {
	  	 	 			autopilotPrice += parseFloat(optEl.dataset.price) || 0;
	  	 	 		}
	  	 	 	});
	  	 	 	optionsPrices.autopilot = autopilotPrice;
	  	 	 	updatePrice();
	  	 });
	};
	
	// Handler per accessori (checkbox)
	const accessoriesSection = document.getElementById('accessories-section');
	if (accessoriesSection) {
		accessoriesSection.addEventListener('change', (e) => {
			if (e.target.classList.contains('accessory-form-checkbox')) {
				let price = 0;
				accessoriesSection.querySelectorAll('.accessory-form-checkbox:checked').forEach(checkbox => {
					price += parseFloat(checkbox.dataset.price) || 0;
				});
				optionsPrices.accessories = price;
				updatePrice();
			}
		});
	}

    handleButtonSelection(optionsContainers.colors, 'button', 'color');
    handleButtonSelection(optionsContainers.intColors, 'button', 'intColor');
    handleButtonSelection(optionsContainers.wheel, '.wheel-option', 'wheel');
  	handlePackageSelection(optionsContainers.packages, '.package-option', 'packages');
  	handleAutopilotSelection(optionsContainers.autopilot, '.advanced-option'); 
    
	// Logica Galleria
    const prevBtn = document.getElementById('prev-image');
    const nextBtn = document.getElementById('next-image');
    const gallery = document.getElementById('exterior-gallery');
    
    if (prevBtn) prevBtn.addEventListener('click', () => {
        const gallerySize = document.querySelectorAll('#exterior-gallery .thumbnail').length;
        if (gallerySize === 0) return;
        const newIndex = (currentGalleryIndex - 1 + gallerySize) % gallerySize;
        showGalleryImage(newIndex);
    });
    
    if (nextBtn) nextBtn.addEventListener('click', () => {
        const gallerySize = document.querySelectorAll('#exterior-gallery .thumbnail').length;
        if (gallerySize === 0) return;
        const newIndex = (currentGalleryIndex + 1) % gallerySize;
        showGalleryImage(newIndex);
    });
	
	if (gallery) {
		gallery.addEventListener('click', (e) => {
			const thumb = e.target.closest('.thumbnail');
			if(!thumb) return;
			const allThumbs = Array.from(gallery.querySelectorAll('.thumbnail'));
			const index = allThumbs.indexOf(thumb);
			if (index !== -1) {
				showGalleryImage(index);
			}
		});
	}

	// Logica Dropdown
	const advancedToggle = document.getElementById('advanced-toggle');
	const advancedContent = document.getElementById('advanced-content');
	const advancedChevron = document.getElementById('advanced-chevron');
	
	if(advancedToggle) advancedToggle.addEventListener('click', () => {
		advancedContent.classList.toggle('open');
 		advancedChevron.classList.toggle('rotate-180');
	});
	
	document.querySelectorAll('.accessory-category-toggle').forEach(toggle => {
 		toggle.addEventListener('click', function() {
 			const dropdown = this.nextElementSibling;
 			const chevron = this.querySelector('.accessory-chevron');
 			if(dropdown) dropdown.classList.toggle('open');
 			if(chevron) chevron.classList.toggle('rotate-180');
 		});
	});
});